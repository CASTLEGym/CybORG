import argparse
import inspect
import random
import json
import base64
import sys

from CybORG.Emulator.Actions.Velociraptor.SSHConnectionServerAction import SSHConnectionServerAction

def parseCmdLineArgs ():
    # parse the command line
    parser = argparse.ArgumentParser ()

    # add optional arguments
    parser.add_argument ("-m", "--remote_hostname", default="0.0.0.0", help="Remote IP Address")
    parser.add_argument ("-u", "--remote_username", default="root", help="Remote Username")
    parser.add_argument ("-p", "--password", default="1234", help="Remote Password")    
    parser.add_argument ("-data", "--additional_data", help="Additional data as base64 encoded JSON string")
    # parse the args
    args = parser.parse_args ()

    return args

if __name__ == "__main__":
    try: 
        parsed_args = parseCmdLineArgs ()
        
        remote_hostname = parsed_args.remote_hostname
        remote_username = parsed_args.remote_username
        remote_password = parsed_args.password
        
        conn_key = SSHConnectionServerAction.get_connection_key()
        
        available_ports = {}
        if parsed_args.additional_data:
            json_str = base64.b64decode(parsed_args.additional_data).decode('utf-8')
            additional_data = json.loads(json_str)
            available_ports = additional_data['available_ports']
        
        client_port= random.choice(available_ports) #4444 # @To-Do how can we used a value in an object in a stateless script
        server_port=22
        
        print(f"{conn_key},{remote_hostname},{remote_username},{remote_password},{client_port}")
        
        
    except KeyboardInterrupt:
        print("Interrupted! Cleaning up before exiting.", file=sys.stderr)
        sys.exit(1)